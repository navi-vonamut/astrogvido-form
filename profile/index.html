<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astro Gvido — Профиль</title>

  <link rel="stylesheet" href="../stylesheet/bootstrap.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/gijgo@1.9.14/css/gijgo.min.css" />
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="../javascript/bootstrap.bundle.min.js"></script>

  <meta name="api-base" content="https://api.astrogvido.ru">

  <style>
    .placeholder-block {
      min-height: 5rem;
    }

    .text-mono {
      font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }

    .badge-soft {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
  </style>
</head>

<body class="bg-body-tertiary">
  <div class="container">
    <main class="py-4">
      <div class="p-3 text-center">
        <img class="d-block mx-auto mb-4" src="../image/cute-chibi-style-fantasy-creature-inspired-by-taur (1).png" alt=""
          width="72" height="72" />
        <h1 class="h2">Профиль и транзиты</h1>
        <p class="lead">Здесь можно посмотреть сохранённые данные и выбрать удобное время для интерпретации транзитов.</p>
      </div>

      <div class="row justify-content-center g-4">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Сохранённые данные</h2>
                <span class="badge rounded-pill badge-soft" id="profile-status">Загрузка…</span>
              </div>
              <div id="profile-error" class="alert alert-danger d-none" role="alert"></div>
              <dl class="row mb-0" id="profile-details">
                <div class="col-12 placeholder-wave placeholder-block">
                  <span class="placeholder col-7"></span>
                  <span class="placeholder col-4"></span>
                  <span class="placeholder col-6"></span>
                </div>
              </dl>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Время интерпретации транзитов</h2>
                <span class="badge rounded-pill badge-soft" id="schedule-status">Загрузка…</span>
              </div>
              <div id="schedule-error" class="alert alert-danger d-none" role="alert"></div>
              <form id="schedule-form" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label for="transit-time" class="form-label">Выберите локальное время</label>
                  <input type="time" class="form-control" id="transit-time" required />
                  <div class="form-text">Мы пришлём новый разбор транзитов в указанное время.</div>
                  <div class="invalid-feedback">Укажите время.</div>
                </div>
                <div class="mb-3">
                  <label for="transit-comment" class="form-label">Комментарий (необязательно)</label>
                  <textarea class="form-control" id="transit-comment" rows="2" placeholder="Например: «Лучше вечером»"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="schedule-save">Сохранить</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = getApiBase();
    const TG_INIT_DATA = window.Telegram?.WebApp?.initData || '';
    const TG_INIT_DATA_UNSAFE = window.Telegram?.WebApp?.initDataUnsafe || {};

    function getApiBase() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get('api');
      const fromMeta = document.querySelector('meta[name="api-base"]')?.content;
      const fallback = 'https://api.astrogvido.ru/';
      const base = (fromQS || fromMeta || fallback).trim();
      return base.endsWith('/') ? base : base + '/';
    }

    function apiUrl(path, params) {
      const url = new URL(path, API_BASE);
      if (params) {
        Object.entries(params).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== '') {
            url.searchParams.set(k, v);
          }
        });
      }
      return url.toString();
    }

    function buildHeaders(extra) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, extra || {});
      const qs = new URLSearchParams(location.search);
      const token = qs.get('token') || qs.get('auth') || '';
      if (token) {
        headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
      }
      if (TG_INIT_DATA) {
        headers['X-Telegram-Init-Data'] = TG_INIT_DATA;
      }
      return headers;
    }

    function normalizeTime(value) {
      if (!value) return null;
      if (/^\d{2}:\d{2}$/.test(value)) {
        return `${value}:00`;
      }
      return value;
    }

    async function fetchJson(path, options = {}) {
      const config = Object.assign({
        method: 'GET',
        headers: buildHeaders(options.headers),
        credentials: 'include'
      }, options);

      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
        config.body = JSON.stringify(options.body);
      }

      const response = await fetch(path, config);
      const text = await response.text();
      let data = null;
      if (text) {
        try {
          data = JSON.parse(text);
        } catch (error) {
          console.warn('Invalid JSON response', error);
        }
      }
      if (!response.ok) {
        const detail = data?.detail || data?.message || response.statusText || 'Ошибка запроса';
        throw new Error(detail);
      }
      return data;
    }

    function renderProfile(profile) {
      const container = document.getElementById('profile-details');
      container.innerHTML = '';
      if (!profile) {
        container.innerHTML = '<p class="text-muted mb-0">Данные не найдены.</p>';
        return;
      }

      const fields = [
        { label: 'Имя', value: profile.name || '—' },
        { label: 'Дата рождения', value: profile.date_local || '—' },
        { label: 'Время рождения', value: profile.time_local || '—' },
        { label: 'Место', value: profile.place?.display_name || profile.city || '—' },
        { label: 'Источник', value: profile.yandex_uri ? 'Яндекс Справочник' : 'Свободный ввод' },
        { label: 'Яндекс URI', value: profile.yandex_uri || '—', mono: true }
      ];

      fields.forEach(({ label, value, mono }) => {
        const dt = document.createElement('dt');
        dt.className = 'col-sm-5 text-muted';
        dt.textContent = label;
        const dd = document.createElement('dd');
        dd.className = 'col-sm-7';
        dd.textContent = value;
        if (mono) {
          dd.classList.add('text-mono');
        }
        container.appendChild(dt);
        container.appendChild(dd);
      });
    }

    function setStatus(id, text, variant = 'primary') {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
      el.className = `badge rounded-pill badge-soft text-${variant}`;
    }

    function showError(id, message) {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.classList.add('d-none');
        el.textContent = '';
      } else {
        el.classList.remove('d-none');
        el.textContent = message;
      }
    }

    async function loadProfile() {
      const qs = new URLSearchParams(location.search);
      const profileId = qs.get('profile_id') || qs.get('profileId') || TG_INIT_DATA_UNSAFE?.user?.id || '';
      const params = profileId ? { profile_id: profileId } : undefined;
      setStatus('profile-status', 'Загрузка…');
      showError('profile-error', null);

      try {
        const data = await fetchJson(apiUrl('/natal/profile', params));
        const profile = data?.profile || data;
        renderProfile(profile);
        setStatus('profile-status', 'Готово', 'success');
      } catch (error) {
        renderProfile(null);
        setStatus('profile-status', 'Ошибка', 'danger');
        showError('profile-error', error.message || 'Не удалось загрузить профиль');
      }
    }

    async function loadSchedule() {
      setStatus('schedule-status', 'Загрузка…');
      showError('schedule-error', null);
      try {
        const data = await fetchJson(apiUrl('/transits/schedule'));
        const schedule = data?.schedule || data;
        if (schedule?.time_local) {
          document.getElementById('transit-time').value = schedule.time_local.slice(0, 5);
        }
        if (schedule?.comment) {
          document.getElementById('transit-comment').value = schedule.comment;
        }
        setStatus('schedule-status', 'Готово', 'success');
      } catch (error) {
        setStatus('schedule-status', 'Ошибка', 'danger');
        showError('schedule-error', error.message || 'Не удалось загрузить расписание');
      }
    }

    async function saveSchedule(event) {
      event.preventDefault();
      const form = event.currentTarget;
      form.classList.add('was-validated');
      if (!form.checkValidity()) {
        return;
      }

      const submitButton = document.getElementById('schedule-save');
      submitButton.disabled = true;
      submitButton.textContent = 'Сохранение…';
      showError('schedule-error', null);

      const time = normalizeTime(document.getElementById('transit-time').value);
      const comment = document.getElementById('transit-comment').value.trim();

      try {
        await fetchJson(apiUrl('/transits/schedule'), {
          method: 'PUT',
          body: { time_local: time, comment: comment || null }
        });
        setStatus('schedule-status', 'Сохранено', 'success');
      } catch (error) {
        setStatus('schedule-status', 'Ошибка', 'danger');
        showError('schedule-error', error.message || 'Не удалось сохранить расписание');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Сохранить';
      }
    }

    document.getElementById('schedule-form').addEventListener('submit', saveSchedule);

    loadProfile();
    loadSchedule();
  </script>
</body>

</html>
