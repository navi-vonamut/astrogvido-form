<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astro Gvido — Профиль</title>

  <link rel="stylesheet" href="../stylesheet/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../javascript/bootstrap.bundle.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta name="api-base" content="https://api.astrogvido.ru">

  <style>
    .placeholder-block {
      min-height: 5rem;
    }

    .text-mono {
      font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }

    .badge-soft {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
  </style>
</head>

<body class="bg-body-tertiary">
  <div class="container">
    <main class="py-4">
      <div class="p-3 text-center">
        <img class="d-block mx-auto mb-4" src="../image/cute-chibi-style-fantasy-creature-inspired-by-taur (1).png" alt=""
          width="72" height="72" />
        <h1 class="h2">Профиль и транзиты</h1>
        <p class="lead">Здесь можно посмотреть сохранённые данные и выбрать удобное время для интерпретации транзитов.</p>
      </div>

      <div class="row justify-content-center g-4">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Сохранённые данные</h2>
                <span class="badge rounded-pill badge-soft" id="profile-status">Загрузка…</span>
              </div>
              <div id="profile-error" class="alert alert-danger d-none" role="alert"></div>
              <dl class="row mb-0" id="profile-details">
                <div class="col-12 placeholder-wave placeholder-block">
                  <span class="placeholder col-7"></span>
                  <span class="placeholder col-4"></span>
                  <span class="placeholder col-6"></span>
                </div>
              </dl>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Время интерпретации транзитов</h2>
                <span class="badge rounded-pill badge-soft" id="schedule-status">Загрузка…</span>
              </div>
              <div id="schedule-error" class="alert alert-danger d-none" role="alert"></div>
              <form id="schedule-form" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label for="transit-time" class="form-label">Выберите локальное время</label>
                  <input type="time" class="form-control" id="transit-time" required />
                  <div class="form-text">Мы пришлём новый разбор транзитов в указанное время.</div>
                  <div class="invalid-feedback">Укажите время.</div>
                </div>
                <div class="mb-3">
                  <label for="transit-comment" class="form-label">Комментарий (необязательно)</label>
                  <textarea class="form-control" id="transit-comment" rows="2" placeholder="Например: «Лучше вечером»"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="schedule-save">Сохранить</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
  // ---------- helpers ----------
  function getApiBase() {
    const fromMeta = document.querySelector('meta[name="api-base"]')?.content || '';
    return fromMeta.replace(/\/+$/, '');
  }
  const API_BASE = getApiBase();

  const tg = window.Telegram?.WebApp;
  tg?.ready();

  function pickInitData() {
    // 1) нормальный путь в WebApp
    if (tg?.initData && tg.initData.length > 0) return tg.initData;

    // 2) ?init_data=... или ?tgWebAppData=...
    const sp = new URLSearchParams(location.search);
    const q1 = sp.get('init_data') || sp.get('tgWebAppData');
    if (q1) return q1;

    // 3) #init_data=... или #tgWebAppData=...
    const hp = new URLSearchParams(location.hash.startsWith('#') ? location.hash.slice(1) : location.hash);
    const q2 = hp.get('init_data') || hp.get('tgWebAppData');
    if (q2) return q2;

    return '';
  }
  const INIT_DATA = pickInitData();
  // быстрая проверка в консоли
  console.debug('[profile] tg?', !!tg, 'initData.len', INIT_DATA.length);


  async function api(path, options = {}) {
    const url = `${API_BASE}${path}${path.includes('?') ? '&' : '?'}init_data=${encodeURIComponent(INIT_DATA)}`;
    const res = await fetch(url, {
      credentials: 'include',
      ...options,
      headers: { 'Content-Type': 'application/json', ...(options.headers || {}) }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function esc(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---------- UI refs ----------
  const $profileStatus  = () => document.querySelector('#profile-status');
  const $profileError   = () => document.querySelector('#profile-error');
  const $profileDetails = () => document.querySelector('#profile-details');

  const $scheduleStatus = () => document.querySelector('#schedule-status');
  const $scheduleError  = () => document.querySelector('#schedule-error');
  const $scheduleForm   = () => document.querySelector('#schedule-form');
  const $transitTime    = () => document.querySelector('#transit-time');

  function showError(el, msg) {
    const box = el();
    if (!box) return;
    box.textContent = msg;
    box.classList.remove('d-none');
  }
  function hideError(el) {
    const box = el();
    if (!box) return;
    box.classList.add('d-none');
    box.textContent = '';
  }
  function setBadge(el, text) {
    const b = el();
    if (b) b.textContent = text;
  }

  // ---------- Загрузка профиля ----------
  async function loadProfile() {
    setBadge($profileStatus, 'Загрузка…');
    hideError($profileError);

    if (!INIT_DATA) {
      setBadge($profileStatus, 'Ошибка');
      showError($profileError, 'Нет initData. Откройте страницу из Telegram.');
      return;
    }

    try {
      const resp = await api('/tg/profile');
      const p = resp?.profile;

      if (!p) {
        setBadge($profileStatus, 'Нет данных');
        $profileDetails().innerHTML = `
          <div class="col-12 text-muted">Профиль не найден. Сначала заполните форму на главной странице.</div>
        `;
        // пустим время по умолчанию
        if ($transitTime()) $transitTime().value = '';
        return;
      }

      // Отрисовка сведений
      const rows = [
        ['Дата рождения', p.date || '—'],
        ['Время рождения', p.time || '—'],
        ['Часовой пояс', p.tz || '—'],
        ['Широта', p.lat ?? '—'],
        ['Долгота', p.lon ?? '—'],
        ['Время рассылки', p.send_time || '—'],
      ];
      const html = rows.map(([k,v]) => `
        <dt class="col-5 text-secondary">${esc(k)}</dt>
        <dd class="col-7 text-mono">${esc(v)}</dd>
      `).join('');
      $profileDetails().innerHTML = html;

      // Подставим время в инпут
      if ($transitTime()) $transitTime().value = (p.send_time || '').slice(0,5);

      setBadge($profileStatus, 'Готово');
    } catch (e) {
      console.error('loadProfile error:', e);
      setBadge($profileStatus, 'Ошибка');
      showError($profileError, 'Не удалось загрузить профиль.');
    }
  }

  // ---------- Сохранение времени рассылки ----------
  async function saveSchedule(evt) {
    evt?.preventDefault();
    hideError($scheduleError);
    setBadge($scheduleStatus, 'Сохранение…');

    const t = $transitTime()?.value || '';
    // ожидаем формат HH:MM
    if (!/^\d{2}:\d{2}$/.test(t)) {
      setBadge($scheduleStatus, 'Ошибка');
      showError($scheduleError, 'Неверный формат времени. Укажите HH:MM.');
      return;
    }

    try {
      await api('/tg/profile', {
        method: 'PUT',
        body: JSON.stringify({ send_time: t })
      });
      setBadge($scheduleStatus, 'Сохранено');
      // обновим блок сведений
      await loadProfile();
    } catch (e) {
      console.error('saveSchedule error:', e);
      setBadge($scheduleStatus, 'Ошибка');
      showError($scheduleError, 'Не удалось сохранить время.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // сабмит формы времени
    $scheduleForm()?.addEventListener('submit', saveSchedule);
    // первая загрузка профиля
    loadProfile();
  });
</script>

</body>

</html>
