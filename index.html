<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astro Gvido — Профиль рождения</title>

  <!-- Bootstrap + gijgo (как у вас) -->
  <link rel="stylesheet" href="stylesheet/bootstrap.min.css">
  <link href="https://unpkg.com/gijgo@1.9.14/css/gijgo.min.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="javascript/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/gijgo@1.9.14/js/gijgo.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/gijgo@1.9.14/js/messages/messages.ru-ru.js" type="text/javascript"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .city-wrap { position: relative; }
    #city-suggest.dropdown-menu {
      max-height: 280px;
      overflow-y: auto;
      font-size: 0.95rem;
    }
    .hint { color: #9aa0a6; font-size: 0.875rem; }
  </style>
</head>
<body class="bg-body-tertiary">
  <div class="container">
    <main>
      <div class="p-5 text-center">
        <img class="d-block mx-auto mb-4" src="image/cute-chibi-style-fantasy-creature-inspired-by-taur (1).png"
             alt="" width="72" height="72">
        <h1 class="h2">Данные о дне рождения</h1>
        <p class="lead">Укажите имя, город рождения, дату и время. Если время неизвестно — поставим «солнечную» карту (12:00).</p>
      </div>

      <div class="row g-5">
        <div class="col-md-12">
          <h4 class="mb-3">Натальная карта</h4>
          <form class="needs-validation" novalidate>
            <div class="row g-3">
              <div class="col-12">
                <label for="firstName" class="form-label">Имя (необязательно)</label>
                <input type="text" class="form-control" id="firstName" placeholder="Например: Анна">
              </div>

              <div class="col-12 city-wrap">
                <label for="city" class="form-label">Город / населённый пункт</label>
                <input type="text" class="form-control" id="city" placeholder="Начните вводить…"
                       autocomplete="off" required>
                <!-- выпадающее меню подсказок -->
                <div id="city-suggest" class="dropdown-menu w-100"></div>
                <div class="hint mt-1">Подсказки от Яндекс Геосаджеста. Выберите один вариант из списка.</div>
                <div class="invalid-feedback">Укажите город из списка.</div>
              </div>

              <div class="col-6">
                <label class="form-label">Дата рождения</label>
                <input id="datepicker"/>
              </div>

              <div class="col-6">
                <label class="form-label">Время рождения</label>
                <input id="timepicker"/>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="unknownTime">
                  <label class="form-check-label" for="unknownTime">Не знаю время (поставим 12:00)</label>
                </div>
              </div>
            </div>

            <hr class="my-4" />
            <button class="w-100 btn btn-primary btn-lg" type="submit">Сохранить</button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ====== CONFIG ======
    // подставьте реальный адрес API (лучше через переменную окружения на проде)
    const API_BASE = window.API_BASE || "http://localhost:8080";
    const DEBOUNCE_MS = 250;
    const MIN_QUERY = 2;

    // ====== Date/Time ======
    var datepicker, config;
    config = { locale: 'ru-ru', uiLibrary: 'bootstrap5' };

    $(document).ready(function(){
      datepicker = $('#datepicker').datepicker(config);
      $('#timepicker').timepicker({ uiLibrary: 'bootstrap5', modal: false, footer: false });

      $('#unknownTime').on('change', function(){
        $('#timepicker').prop('disabled', this.checked);
      });
    });

    // ====== Suggest (Яндекс через наш прокси) ======
    let sessiontoken = null;    // важно держать в рамках одной сессии ввода
    let selected = null;        // выбранный элемент {label, uri, address}

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function renderSuggestions(items) {
      const $drop = $('#city-suggest');
      $drop.empty();
      if (!items || !items.length) { $drop.removeClass('show'); return; }
      items.forEach(it => {
        const $a = $('<a class="dropdown-item" href="#"></a>').text(it.label);
        $a.on('click', (e) => {
          e.preventDefault();
          selected = it;                 // сохраняем uri
          $('#city').val(it.label);      // показываем выбранный
          $drop.removeClass('show');
        });
        $drop.append($a);
      });
      $drop.addClass('show');
    }

    const suggest = debounce(async function() {
      selected = null;
      const text = $('#city').val().trim();
      if (text.length < MIN_QUERY) { $('#city-suggest').removeClass('show'); return; }
      const params = new URLSearchParams({
        text, lang: 'ru', results: '8', types: 'locality,geo', print_address: '1', attrs: 'uri'
      });
      if (sessiontoken) params.append('sessiontoken', sessiontoken);

      try {
        const r = await fetch(`${API_BASE}/places/suggest_ya?` + params.toString(), { cache: 'no-store' });
        const data = await r.json();
        if (data.sessiontoken) sessiontoken = data.sessiontoken;
        renderSuggestions(data.items || []);
      } catch (e) {
        console.warn('Suggest error', e);
        $('#city-suggest').removeClass('show');
      }
    }, DEBOUNCE_MS);

    $('#city').on('input focus', suggest);
    $(document).on('click', (e) => {
      if (!$(e.target).closest('#city').length && !$(e.target).closest('#city-suggest').length) {
        $('#city-suggest').removeClass('show');
      }
    });

    // ====== Submit ======
    $('form.needs-validation').on('submit', async function(e){
      e.preventDefault();

      const name = $('#firstName').val().trim();
      const date_local = $('#datepicker').val();          // yyyy-mm-dd (gijgo)
      let time_local = $('#unknownTime').is(':checked') ? '12:00:00' : ($('#timepicker').val() || '');
      if (!date_local) { alert('Укажите дату рождения.'); return; }

      if (!time_local) time_local = '12:00:00';
      else if (time_local.length === 5) time_local += ':00';

      const hasUri = !!(selected && selected.uri);
      const payload = {
        name,
        lang: 'ru',
        date_local,
        time_local,
        ...(hasUri ? { yandex_uri: selected.uri } : { city: $('#city').val().trim() })
      };

      // Telegram WebApp → шлём в бота
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
        return;
      }

      // Фоллбек вне Telegram: вызываем API напрямую
      try {
        const r = await fetch(`${API_BASE}/natal/by_city`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.detail || 'Ошибка запроса');
        alert('Профиль сохранён: ' + (data.place?.display_name || 'ok'));
      } catch (err) {
        alert('Не удалось сохранить профиль: ' + err.message);
      }
    });
  </script>
</body>
</html>
