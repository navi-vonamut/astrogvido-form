<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astro Gvido — Профиль рождения</title>

  <!-- Bootstrap + gijgo (как у вас) -->
  <link rel="stylesheet" href="stylesheet/bootstrap.min.css">
  <script src="javascript/bootstrap.bundle.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta name="api-base" content="https://api.astrogvido.ru">


  <style>
    .city-wrap {
      position: relative;
    }

    #city-suggest.dropdown-menu {
      max-height: 280px;
      overflow-y: auto;
      font-size: 0.95rem;
    }

    .hint {
      color: #9aa0a6;
      font-size: 0.875rem;
    }
  </style>
</head>

<body class="bg-body-tertiary">
  <div class="container">
    <main>
      <div class="p-3 text-center">
        <img class="d-block mx-auto mb-4" src="image/cute-chibi-style-fantasy-creature-inspired-by-taur (1).png" alt=""
          width="72" height="72">
        <h1 class="h2">Данные о дне рождения</h1>
        <p class="lead">Укажите имя, город рождения, дату и время. Если время неизвестно — поставим «солнечную» карту
          (12:00).</p>
      </div>
      <div class="row justify-content-center g-4">
        <div class="col-12 col-lg-6">
          <div class="card">
            <div class="card-body">
              <div class="row g-5">
                <div class="col-md-12">
                  <h4 class="mb-3 card-title">Натальная карта</h4>
                  <form class="needs-validation" novalidate>
                    <div class="row g-3">
                      <div class="col-12">
                        <label for="firstName" class="form-label">Имя (необязательно)</label>
                        <input type="text" class="form-control" id="firstName" placeholder="Например: Анна">
                      </div>

                      <div class="col-12 city-wrap">
                        <label for="city" class="form-label">Город / населённый пункт</label>
                        <input type="text" class="form-control" id="city" placeholder="Начните вводить…"
                          autocomplete="off" required>
                        <!-- выпадающее меню подсказок -->
                        <div id="city-suggest" class="dropdown-menu w-100"></div>
                        <div class="invalid-feedback">Укажите город из списка.</div>
                      </div>

                      <div class="col-6">
                        <label class="form-label">Дата рождения</label>
                        <input  type="date" class="form-control" id="datepicker"  required/>
                      </div>

                      <div class="col-6">
                        <label class="form-label">Время рождения</label>
                        <input  type="time" class="form-control" id="timepicker" required/>
                        <div class="form-check mt-2">
                          <input class="form-check-input" type="checkbox" id="unknownTime">
                          <label class="form-check-label" for="unknownTime">Не знаю время (поставим 12:00)</label>
                        </div>
                      </div>
                    </div>

                    <hr class="my-4" />
                    <button class="w-100 btn btn-primary btn-lg" type="submit">Сохранить</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ====== CONFIG ======
    const DEBOUNCE_MS = 250;
    const MIN_QUERY = 2;

    // ====== API base detection ======
    function getApiBase() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get('api'); // можно ?api=https://dev-api.example.com
      const fromMeta = document.querySelector('meta[name="api-base"]')?.content;
      const fallback = 'https://api.astrogvido.ru/';
      const base = (fromQS || fromMeta || fallback).trim();
      return base.endsWith('/') ? base : base + '/';
    }
    const API_BASE = getApiBase();

    // Нормальная сборка URL (правит слэши и кодирует параметры)
    function apiUrl(path, params) {
      const u = new URL(path, API_BASE);
      if (params) {
        for (const [k, v] of Object.entries(params)) {
          if (v !== undefined && v !== null) u.searchParams.set(k, String(v));
        }
      }
      return u.toString();
    }

    // ====== Session token для Геосаджеста (один на сессию страницы) ======
    const SESSIONTOKEN = (self.crypto?.randomUUID?.() || Math.random().toString(36).slice(2));

    // ====== Контекст карты (ll/spn) — не обязательно, но повышает релевантность ======
    let SUGGEST_LL = null; // "lon,lat"
    let SUGGEST_SPN = null; // "lonSpan,latSpan"
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          // Примерно: окно 10°x8° — можно подстроить
          SUGGEST_LL = `${longitude.toFixed(4)},${latitude.toFixed(4)}`;
          SUGGEST_SPN = '10,8';
        },
        () => { /* молча игнорируем отказ */ },
        { maximumAge: 60_000, timeout: 2_000, enableHighAccuracy: false }
      );
    }


    // ====== Suggest (Яндекс через наш API) ======
    let selected = null; // выбранный элемент {label, uri, address}
    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

    function renderSuggestions(items) {
      const $drop = $('#city-suggest');
      $drop.empty();
      if (!items || !items.length) { $drop.removeClass('show'); return; }
      items.forEach(it => {
        const $a = $('<a class="dropdown-item" href="#"></a>').text(it.label);
        $a.on('click', (e) => {
          e.preventDefault();
          selected = it;
          $('#city').val(it.label);
          $drop.removeClass('show');
        });
        $drop.append($a);
      });
      $drop.addClass('show');
    }

    const suggest = debounce(async function () {
      selected = null;
      const text = $('#city').val().trim();
      if (text.length < MIN_QUERY) { $('#city-suggest').removeClass('show'); return; }

      const params = {
        text,                       // НЕ кодируем вручную — URLSearchParams сделает сам
        lang: 'ru_RU',              // нормализованный язык для Яндекса
        results: 8,
        types: 'geo',               // можно 'locality,geo' если хотите сузить
        print_address: 1,
        attrs: 'uri',
        sessiontoken: SESSIONTOKEN
      };
      if (SUGGEST_LL) params.ll = SUGGEST_LL;
      if (SUGGEST_SPN) params.spn = SUGGEST_SPN;

      try {
        const url = apiUrl('/places/suggest_ya', params);
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error('Suggest HTTP ' + r.status);
        const data = await r.json();
        renderSuggestions(data.items || []);
      } catch (e) {
        console.warn('Suggest error', e);
        $('#city-suggest').removeClass('show');
      }
    }, DEBOUNCE_MS);

    $('#city').on('input focus', suggest);
    $(document).on('click', (e) => {
      if (!$(e.target).closest('#city').length && !$(e.target).closest('#city-suggest').length) {
        $('#city-suggest').removeClass('show');
      }
    });

    // ====== Submit ======
    $('form.needs-validation').on('submit', async function (e) {
      e.preventDefault();

      const name = $('#firstName').val().trim();
      const date_local = $('#datepicker').val(); // yyyy-mm-dd (gijgo)
      let time_local = $('#unknownTime').is(':checked') ? '12:00:00' : ($('#timepicker').val() || '');

      if (!date_local) { alert('Укажите дату рождения.'); return; }
      if (!time_local) time_local = '12:00:00';
      else if (time_local.length === 5) time_local += ':00';

      const cityVal = $('#city').val().trim();
      const hasUri = !!(selected && selected.uri);

      const payload = {
        name,
        lang: 'ru',
        date_local,
        time_local,
        ...(hasUri ? { yandex_uri: selected.uri } : (cityVal ? { city: cityVal } : {}))
      };

      // Если открыто как Telegram WebApp — отдаём данные в бота
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
        return;
      }

      // Фоллбек вне Telegram: вызываем API напрямую
      try {
        const r = await fetch(apiUrl('/natal/by_city'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.detail || 'Ошибка запроса');
        alert('Профиль сохранён: ' + (data.place?.display_name || 'ok'));
      } catch (err) {
        alert('Не удалось сохранить профиль: ' + err.message);
      }
    });
  </script>

</body>

</html>